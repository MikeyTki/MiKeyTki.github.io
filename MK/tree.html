<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Musical Christmas Lights</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #161616;
            color: #c5a880;
            font-family: sans-serif;
        }

        label {
            display: inline-block;
            background-color: #161616;
            padding: 16px;
            border-radius: 0.3rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 300px;
            border-radius: 10px;
            border: 1px solid #c5a880;
            text-align: center;
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .btn {
            background-color: #161616;
            border-radius: 10px;
            color: #c5a880;
            border: 1px solid #c5a880;
            padding: 16px;
            width: 300px;
            margin-bottom: 16px;
            line-height: 1.5;
            cursor: pointer;
        }

        .separator {
            font-weight: bold;
            text-align: center;
            width: 300px;
            margin: 16px 0px;
            color: #a07676;
        }

        .title {
            color: #a07676;
            font-weight: bold;
            font-size: 1.25rem;
            margin-bottom: 16px;
        }

        .text-loading {
            font-size: 2rem;
        }
    </style>
    <script>
        window.console = window.console || function (t) { };
    </script>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <div id="overlay">
        <ul>
            <li class="title">请选择音乐</li>
            <li>
                <button class="btn" id="btnA" type="button">
                    Snowflakes Falling Down by Simon Panrucker
                </button>
            </li>
            <li><button class="btn" id="btnB" type="button">This Christmas by Dott</button></li>
            <li><button class="btn" id="btnC" type="button">No room at the inn by TRG Banks</button></li>
            <li><button class="btn" id="btnD" type="button">Jingle Bell Swing by Mark Smeby</button></li>
            <li class="separator">或者</li>
            <li>
                <input type="file" id="upload" hidden />
                <label for="upload">file</label>
            </li>
        </ul>
    </div>

    <script id="rendered-js">
        const { PI, sin, cos } = Math;
        const TAU = 2 * PI;

        const map = (value, sMin, sMax, dMin, dMax) => {
            return dMin + (value - sMin) / (sMax - sMin) * (dMax - dMin);
        };

        const range = (n, m = 0) =>
            Array(n).fill(m).map((i, j) => i + j);

        const rand = (max, min = 0) => min + Math.random() * (max - min);
        const randInt = (max, min = 0) => Math.floor(min + Math.random() * (max - min));
        const randChoice = arr => arr[randInt(arr.length)];
        const polar = (ang, r = 1) => [r * cos(ang), r * sin(ang)];

        let scene, camera, renderer, analyser;
        let step = 0;
        const uniforms = {
            time: { type: "f", value: 0.0 },
            step: { type: "f", value: 0.0 }
        };

        const params = {
            exposure: 1,
            bloomStrength: 0.9,
            bloomThreshold: 0,
            bloomRadius: 0.5
        };

        let composer;

        const fftSize = 2048;
        const totalPoints = 4000;

        const listener = new THREE.AudioListener();
        const audio = new THREE.Audio(listener);

        document.querySelector("input").addEventListener("change", uploadAudio, false);

        const buttons = document.querySelectorAll(".btn");
        buttons.forEach((button, index) =>
            button.addEventListener("click", () => loadAudio(index)));

        function init() {
            const overlay = document.getElementById("overlay");
            overlay.remove();

            scene = new THREE.Scene();
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(-0.09397456774197047, -2.5597086635726947, 24.420789670889008);
            camera.rotation.set(0.10443543723052419, -0.003827152981119352, 0.0004011488708739715);

            const format = renderer.capabilities.isWebGL2 ? THREE.RedFormat : THREE.LuminanceFormat;

            uniforms.tAudioData = {
                value: new THREE.DataTexture(analyser.data, fftSize / 2, 1, format)
            };

            addPlane(scene, uniforms, 3000);
            addSnow(scene, uniforms);

            range(10).map(i => {
                addTree(scene, uniforms, totalPoints, [20, 0, -20 * i]);
                addTree(scene, uniforms, totalPoints, [-20, 0, -20 * i]);
            });

            const renderScene = new THREE.RenderPass(scene, camera);

            const bloomPass = new THREE.UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5, 0.4, 0.85
            );

            bloomPass.threshold = params.bloomThreshold;
            bloomPass.strength = params.bloomStrength;
            bloomPass.radius = params.bloomRadius;

            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            addListeners(camera, renderer, composer);
            animate();
        }

        function animate(time) {
            analyser.getFrequencyData();
            uniforms.tAudioData.value.needsUpdate = true;
            step = (step + 1) % 1000;
            uniforms.time.value = time;
            uniforms.step.value = step;
            composer.render();
            requestAnimationFrame(animate);
        }

        function loadAudio(i) {
            document.getElementById("overlay").innerHTML = '<div class="text-loading">等一下哈 马上来啦...</div>';
            const files = [
                "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Simon_Panrucker/Happy_Christmas_You_Guys/Simon_Panrucker_-_01_-_Snowflakes_Falling_Down.mp3",
                "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Dott/This_Christmas/Dott_-_01_-_This_Christmas.mp3",
                "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/TRG_Banks/TRG_Banks_Christmas_Album/TRG_Banks_-_12_-_No_room_at_the_inn.mp3",
                "https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Mark_Smeby/En_attendant_Nol/Mark_Smeby_-_07_-_Jingle_Bell_Swing.mp3"
            ];

            const file = files[i];

            const loader = new THREE.AudioLoader();
            loader.load(file, function (buffer) {
                audio.setBuffer(buffer);
                audio.play();
                analyser = new THREE.AudioAnalyser(audio, fftSize);
                init();
            });
        }

        function uploadAudio(event) {
            document.getElementById("overlay").innerHTML = '<div class="text-loading">等一下哈 马上来啦...</div>';
            const files = event.target.files;
            const reader = new FileReader();

            reader.onload = function (file) {
                var arrayBuffer = file.target.result;

                listener.context.decodeAudioData(arrayBuffer, function (audioBuffer) {
                    audio.setBuffer(audioBuffer);
                    audio.play();
                    analyser = new THREE.AudioAnalyser(audio, fftSize);
                    init();
                });
            };

            reader.readAsArrayBuffer(files[0]);
        }

        function addTree(scene, uniforms, totalPoints, treePosition) {
            const vertexShader = `
            attribute float mIndex;
            varying vec3 vColor;
            varying float opacity;
            uniform sampler2D tAudioData;
            float norm(float value, float min, float max ){
                return (value - min) / (max - min);
            }
            void main() {
                float fIndx = mod(mIndex, 512.0);
                float audioData = texture2D(tAudioData, vec2(fIndx / 512.0, 0.0)).r;
                float maxHeight = 40.0;
                vec3 pos = position;
                pos.y += audioData * maxHeight;
                opacity = norm(audioData, 0.0, 0.4);
                vColor = color * (0.5 + 0.5 * sin(time * 0.1 + mIndex));
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            }`;

            const fragmentShader = `
            varying vec3 vColor;
            varying float opacity;
            void main() {
                gl_FragColor = vec4(vColor, opacity);
            }`;

            const material = new THREE.ShaderMaterial({
                uniforms,
                vertexShader,
                fragmentShader,
                transparent: true,
                vertexColors: true,
                blending: THREE.AdditiveBlending
            });

            const geometry = new THREE.BufferGeometry();
            const vertices = new Float32Array(totalPoints * 3);
            const colors = new Float32Array(totalPoints * 3);
            const indices = new Float32Array(totalPoints);
            for (let i = 0; i < totalPoints; i++) {
                const [x, z] = polar(rand(TAU), rand(2));
                const y = rand(40);
                vertices.set([x, y, z], i * 3);
                colors.set([1, 1, 1], i * 3);
                indices[i] = i;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('mIndex', new THREE.BufferAttribute(indices, 1));

            const mesh = new THREE.Points(geometry, material);
            mesh.position.set(...treePosition);
            scene.add(mesh);
        }

        function addPlane(scene, uniforms, size) {
            const geometry = new THREE.PlaneGeometry(size, size);
            const material = new THREE.ShaderMaterial({
                uniforms,
                vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }`,
                fragmentShader: `
                varying vec2 vUv;
                uniform sampler2D tAudioData;
                void main() {
                    float audioData = texture2D(tAudioData, vec2(vUv.x, 0.0)).r;
                    gl_FragColor = vec4(vec3(0.0, 0.5 * audioData, 0.5 * (1.0 - audioData)), 1.0);
                }`,
                transparent: true,
                blending: THREE.AdditiveBlending
            });

            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }

        function addSnow(scene, uniforms) {
            const snowGeometry = new THREE.BufferGeometry();
            const snowMaterial = new THREE.PointsMaterial({ color: 0xFFFFFF });
            const snowCount = 10000;
            const positions = new Float32Array(snowCount * 3);
            for (let i = 0; i < snowCount; i++) {
                positions[i * 3] = rand(400) - 200;
                positions[i * 3 + 1] = rand(400) - 200;
                positions[i * 3 + 2] = rand(400) - 200;
            }
            snowGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const snow = new THREE.Points(snowGeometry, snowMaterial);
            scene.add(snow);
        }

        function addListeners(camera, renderer, composer) {
            window.addEventListener('resize', onWindowResize, false);
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Initial prompt
            document.getElementById("overlay").style.display = "block";
        });
    </script>
</body>

</html>

       
